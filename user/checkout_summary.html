<!DOCTYPE html>

<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Checkout Summary</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400,500,600,700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    screens: {
                        'xs': '280px',
                        'sm': '640px',
                        'md': '768px',
                        'lg': '1024px',
                        'xl': '1280px',
                        '2xl': '1536px',
                        '3xl': '1920px',
                        '4xl': '2560px',
                    },
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  
        /* Enhanced responsive design for all devices */
        @media (min-width: 280px) {
            :root {
                font-size: clamp(12px, 3vw, 16px);
            }
        }
        @media (min-width: 640px) {
            :root {
                font-size: clamp(14px, 2vw, 16px);
            }
        }
        @media (min-width: 1024px) {
            :root {
                font-size: clamp(15px, 1.2vw, 18px);
            }
        }
        @media (min-width: 1920px) {
            :root {
                font-size: clamp(16px, 1vw, 20px);
            }
        }
        @media (min-width: 2560px) {
            :root {
                font-size: clamp(18px, 0.8vw, 24px);
            }
        }
        
        .container-responsive {
            max-width: clamp(280px, 100%, 1920px);
            margin: 0 auto;
            padding: clamp(0.5rem, 2vw, 2rem);
        }
        
        .text-responsive {
            font-size: clamp(0.875rem, 2vw, 1rem);
        }
        
        .heading-responsive {
            font-size: clamp(1.25rem, 3vw, 2rem);
        }

    </style>
  </head>
<body class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased">
<div class="relative flex h-screen w-full flex-col overflow-x-hidden">
<!-- TopAppBar -->
<header class="flex items-center bg-background-light dark:bg-background-dark p-4 sticky top-0 z-10">
<a href="browse_cars.php" class="text-primary flex size-10 items-center justify-center rounded-full hover:bg-primary/10 transition-colors" data-icon="arrow_back_ios">
<span class="material-symbols-outlined text-xl">arrow_back_ios</span>
</a>
<h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight flex-1 text-center pr-10">Checkout Summary</h2>
</header>
<main class="flex-1 overflow-y-auto pb-32">

<!-- Loading State -->
<div id="loadingState" class="p-8 text-center">
    <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent"></div>
    <p class="mt-4 text-slate-500">Loading booking details...</p>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
<!-- SectionHeader -->
<h3 class="text-slate-900 dark:text-white text-xl font-bold leading-tight tracking-tight px-4 pt-6 pb-2">Selected Vehicle</h3>
<!-- Card -->
<div class="px-4">
<div class="flex items-stretch justify-between gap-4 rounded-xl bg-white dark:bg-[#192633] p-4 shadow-sm border border-slate-200 dark:border-slate-800">
<div class="flex flex-col gap-1 flex-[2_2_0px]">
<p id="vehicleType" class="text-primary text-xs font-semibold uppercase tracking-wider">Loading...</p>
<p id="vehicleName" class="text-slate-900 dark:text-white text-lg font-bold leading-tight">Loading...</p>
<p id="vehicleDetails" class="text-slate-500 dark:text-[#92adc9] text-sm font-normal leading-normal">Loading...</p>
<div class="flex gap-2 mt-2">
<span id="vehicleTransmission" class="flex items-center gap-1 text-xs bg-slate-100 dark:bg-[#233648] px-2 py-1 rounded text-slate-600 dark:text-[#92adc9]">
<span class="material-symbols-outlined text-sm">settings_input_component</span> Loading
                             </span>
</div>
</div>
<div id="vehicleImage" class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-lg flex-1 shadow-inner" style='background-image: url("https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?auto=format&fit=crop&q=80&w=400");'>
</div>
</div>
</div>

<!-- Date Selection -->
<div class="px-4 pt-6">
<h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight pb-4">Select Rental Period</h3>
<div class="grid grid-cols-1 gap-4">
    <div class="flex flex-col gap-1">
        <label class="text-slate-700 dark:text-white text-sm font-medium px-1">Pickup Date & Time</label>
        <input id="pickupDate" type="datetime-local" class="w-full rounded-lg border border-slate-300 dark:border-[#324d67] bg-white dark:bg-[#192633] py-3 px-4 text-slate-900 dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" required/>
    </div>
    <div class="flex flex-col gap-1">
        <label class="text-slate-700 dark:text-white text-sm font-medium px-1">Dropoff Date & Time</label>
        <input id="dropoffDate" type="datetime-local" class="w-full rounded-lg border border-slate-300 dark:border-[#324d67] bg-white dark:bg-[#192633] py-3 px-4 text-slate-900 dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" required/>
    </div>
</div>
</div>

<!-- Location Selection -->
<div class="px-4 pt-6">
    <h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight pb-4">Pickup Location</h3>
    <div class="flex flex-col gap-4">
        <div>
            <label class="text-slate-700 dark:text-white text-sm font-medium px-1 mb-1 block">Full Address</label>
            <div class="flex gap-2">
                <input id="location" type="text" class="flex-1 rounded-lg border border-slate-300 dark:border-[#324d67] bg-white dark:bg-[#192633] py-3 px-4 text-slate-900 dark:text-white placeholder:text-slate-400 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" placeholder="Enter complete address" required/>
                <button type="button" onclick="verifyLocation('location', map, marker, 'pickupLat', 'pickupLng')" class="bg-primary/10 text-primary px-4 rounded-lg font-bold text-xs hover:bg-primary hover:text-white transition-all flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">location_on</span> Verify
                </button>
            </div>
        </div>
        <div>
            <label class="text-slate-700 dark:text-white text-sm font-medium px-1 mb-1 block">Area Description</label>
            <textarea id="pickupDescription" rows="2" class="w-full rounded-lg border border-slate-300 dark:border-[#324d67] bg-white dark:bg-[#192633] py-3 px-4 text-slate-900 dark:text-white placeholder:text-slate-400 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" placeholder="Describe the area (e.g., near the blue gate, beside the church)"></textarea>
        </div>
        <div>
            <label class="text-slate-700 dark:text-white text-sm font-medium px-1 mb-1 block">Pin Exact Location</label>
            <div id="pickupMap" class="w-full h-64 rounded-xl border border-slate-300 dark:border-[#324d67] z-0"></div>
            <p class="text-[10px] text-slate-500 mt-1">Drag the marker to your exact pickup spot.</p>
        </div>
        <input type="hidden" id="pickupLat">
        <input type="hidden" id="pickupLng">
    </div>
</div>

<!-- Return Location Selection -->
<div class="px-4 pt-6">
    <h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight pb-4">Return Location</h3>
    <div class="flex flex-col gap-4">
        <div>
            <label class="text-slate-700 dark:text-white text-sm font-medium px-1 mb-1 block">Full Return Address</label>
            <div class="flex gap-2">
                <input id="dropoffLocation" type="text" class="flex-1 rounded-lg border border-slate-300 dark:border-[#324d67] bg-white dark:bg-[#192633] py-3 px-4 text-slate-900 dark:text-white placeholder:text-slate-400 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" placeholder="Enter complete return address" required/>
                <button type="button" onclick="verifyLocation('dropoffLocation', dropoffMap, dropoffMarker, 'dropoffLat', 'dropoffLng')" class="bg-primary/10 text-primary px-4 rounded-lg font-bold text-xs hover:bg-primary hover:text-white transition-all flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">location_on</span> Verify
                </button>
            </div>
        </div>
        <div>
            <label class="text-slate-700 dark:text-white text-sm font-medium px-1 mb-1 block">Return Area Description</label>
            <textarea id="dropoffDescription" rows="2" class="w-full rounded-lg border border-slate-300 dark:border-[#324d67] bg-white dark:bg-[#192633] py-3 px-4 text-slate-900 dark:text-white placeholder:text-slate-400 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" placeholder="Describe the return area"></textarea>
        </div>
        <div>
            <label class="text-slate-700 dark:text-white text-sm font-medium px-1 mb-1 block">Pin Return Location</label>
            <div id="dropoffMap" class="w-full h-64 rounded-xl border border-slate-300 dark:border-[#324d67] z-0"></div>
            <p class="text-[10px] text-slate-500 mt-1">Drag the marker to your exact return spot.</p>
        </div>
        <input type="hidden" id="dropoffLat">
        <input type="hidden" id="dropoffLng">
    </div>
</div>

<!-- Driver Selection -->
<div class="px-4 pt-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight">Driver Service</h3>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="withDriver" class="sr-only peer">
            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:bg-slate-700 rounded-full peer dark:peer-bg-slate-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
            <span class="ms-3 text-sm font-medium text-slate-700 dark:text-slate-300">With Driver</span>
        </label>
    </div>

    <div id="driverSelectionArea" class="hidden space-y-4">
        <p class="text-xs text-slate-500 dark:text-slate-400">Select your preferred driver from our list of active professionals.</p>
        <div id="driversList" class="grid grid-cols-1 gap-3 max-h-60 overflow-y-auto pr-1">
            <p class="text-center text-sm text-slate-500 py-4">Loading drivers...</p>
        </div>
        <input type="hidden" id="selectedDriverId" name="driver_id">
    </div>
</div>

<!-- Pricing Breakdown -->
<div class="px-4 pt-8">
<h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight pb-4">Payment Breakdown</h3>
<div class="space-y-3 rounded-xl bg-slate-100/50 dark:bg-[#192633]/50 p-4 border border-slate-200 dark:border-slate-800">
<div class="flex justify-between text-sm">
<span class="text-slate-500 dark:text-[#92adc9]">Daily Rate (<span id="ratePerDay">₱0.00</span> x <span id="numDays">0</span> days)</span>
<span id="subtotalAmount" class="text-slate-900 dark:text-white font-medium">₱0.00</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-slate-500 dark:text-[#92adc9]">Insurance (Standard Coverage)</span>
<span id="insuranceAmount" class="text-slate-900 dark:text-white font-medium">₱0.00</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-slate-500 dark:text-[#92adc9]">Service Fee</span>
<span id="serviceFeeAmount" class="text-slate-900 dark:text-white font-medium">₱0.00</span>
</div>
<div class="pt-2 mt-2 border-t border-slate-200 dark:border-slate-800 flex justify-between items-center">
<span class="text-slate-900 dark:text-white font-bold">Total Rental Price</span>
<span id="totalAmount" class="text-slate-900 dark:text-white font-bold text-lg">₱0.00</span>
</div>
</div>
</div>
<!-- Downpayment Card -->
<div class="px-4 mt-6">
<div class="rounded-xl bg-primary/10 border-2 border-primary p-4 flex justify-between items-center shadow-lg shadow-primary/5">
<div>
<p class="text-primary text-xs font-bold uppercase tracking-widest">Downpayment Required</p>
<p id="downpaymentAmount" class="text-slate-900 dark:text-white text-2xl font-black mt-1">₱0.00</p>
<p class="text-slate-500 dark:text-[#92adc9] text-xs mt-1">20% of total due now to confirm</p>
</div>
<div class="text-primary">
<span class="material-symbols-outlined text-4xl" style="font-variation-settings: 'FILL' 1">security</span>
</div>
</div>
</div>
<div class="px-4 py-6 text-center">
<p class="text-xs text-slate-400 dark:text-slate-500">By proceeding, you agree to our Terms of Service and Cancellation Policy. Payment information is secured via 256-bit encryption.</p>
</div>
</div>

</main>
<!-- Sticky Footer -->
<footer class="fixed bottom-0 left-0 right-0 bg-white dark:bg-background-dark p-4 pb-8 border-t border-slate-200 dark:border-slate-800 shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
<button id="proceedButton" class="flex items-center justify-center gap-2 w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed">
<span class="material-symbols-outlined text-lg">lock</span>
<span>Create Booking</span>
<span class="material-symbols-outlined text-lg">arrow_forward</span>
</button>
</footer>
</div>

<script>
let vehicleData = null;
let bookingData = null;
let map, marker;
let dropoffMap, dropoffMarker;

// Get vehicle ID from URL
const urlParams = new URLSearchParams(window.location.search);
const vehicleId = urlParams.get('vehicle');

// Check if user is logged in
const user = JSON.parse(localStorage.getItem('user') || 'null');

if (!user) {
    alert('Please login to make a booking');
    window.location.href = 'user_authentication.html';
}

if (!vehicleId) {
    alert('No vehicle selected');
    window.location.href = 'browse_cars.php';
}

// Load vehicle details
async function loadVehicle() {
    try {
        const response = await fetch(`../api/vehicles.php?status=available`);
        const data = await response.json();
        
        if (data.success && data.data) {
            vehicleData = data.data.find(v => v.id == vehicleId);
            
            if (!vehicleData) {
                alert('Vehicle not found or not available');
                window.location.href = 'browse_cars.php';
                return;
            }
            
            displayVehicle();
            setupDateListeners();
            initMap();
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            setTimeout(() => {
                map.invalidateSize();
                dropoffMap.invalidateSize();
            }, 100);
        }
    } catch (error) {
        console.error('Error loading vehicle:', error);
        alert('Failed to load vehicle details');
    }
}

function displayVehicle() {
    document.getElementById('vehicleType').textContent = vehicleData.vehicle_type.toUpperCase();
    document.getElementById('vehicleName').textContent = `${vehicleData.make} ${vehicleData.model}`;
    document.getElementById('vehicleDetails').textContent = `${vehicleData.fuel_type} • ${vehicleData.seats} seats`;
    document.getElementById('vehicleTransmission').innerHTML = `<span class="material-symbols-outlined text-sm">settings_input_component</span> ${vehicleData.transmission}`;
    
    const imageUrl = vehicleData.display_image || 'https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?auto=format&fit=crop&q=80&w=400';
    document.getElementById('vehicleImage').style.backgroundImage = `url("${imageUrl}")`;
    
    // Set minimum dates to today
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const formatDateForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    
    document.getElementById('pickupDate').min = formatDateForInput(now);
    document.getElementById('pickupDate').value = formatDateForInput(now);
    document.getElementById('dropoffDate').min = formatDateForInput(tomorrow);
    document.getElementById('dropoffDate').value = formatDateForInput(tomorrow);
}

function setupDateListeners() {
    document.getElementById('pickupDate').addEventListener('change', () => {
        calculateTotal();
        if (document.getElementById('withDriver').checked) {
            loadDrivers();
        }
    });
    document.getElementById('dropoffDate').addEventListener('change', () => {
        calculateTotal();
        if (document.getElementById('withDriver').checked) {
            loadDrivers();
        }
    });
    
    // Driver toggle listener
    document.getElementById('withDriver').addEventListener('change', function() {
        const area = document.getElementById('driverSelectionArea');
        if (this.checked) {
            area.classList.remove('hidden');
            loadDrivers();
        } else {
            area.classList.add('hidden');
            document.getElementById('selectedDriverId').value = '';
            calculateTotal();
        }
    });

    // Calculate initial total
    calculateTotal();
}

async function loadDrivers() {
    const pickupDate = document.getElementById('pickupDate').value;
    const dropoffDate = document.getElementById('dropoffDate').value;
    const listElement = document.getElementById('driversList');

    // Reset selected driver when reloading the list
    document.getElementById('selectedDriverId').value = '';

    listElement.innerHTML = '<p class="text-center text-sm text-slate-500 py-4">Loading available drivers...</p>';

    try {
        const response = await fetch(`../api/drivers.php?pickup_date=${pickupDate}&dropoff_date=${dropoffDate}`);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            listElement.innerHTML = '';
            result.data.forEach(driver => {
                const driverCard = document.createElement('div');
                driverCard.className = 'driver-card flex items-center p-3 rounded-xl bg-white dark:bg-[#192633] border border-slate-200 dark:border-slate-800 cursor-pointer hover:border-primary transition-all';
                driverCard.dataset.id = driver.id;
                driverCard.innerHTML = `
                    <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                        <span class="material-symbols-outlined">person</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h4 class="text-sm font-bold text-slate-900 dark:text-white">${driver.first_name} ${driver.last_name}</h4>
                            <div class="flex items-center text-amber-500">
                                <span class="material-symbols-outlined text-xs" style="font-variation-settings: 'FILL' 1">star</span>
                                <span class="text-[10px] font-bold ml-0.5">${driver.rating || 'N/A'}</span>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-500 uppercase font-bold">${driver.experience_years} Years Exp • ${driver.employee_id}</p>
                    </div>
                `;

                driverCard.addEventListener('click', function() {
                    document.querySelectorAll('.driver-card').forEach(c => c.classList.remove('border-primary', 'bg-primary/5'));
                    this.classList.add('border-primary', 'bg-primary/5');
                    document.getElementById('selectedDriverId').value = this.dataset.id;
                });

                listElement.appendChild(driverCard);
            });
        } else {
            listElement.innerHTML = '<p class="text-center text-sm text-slate-500 py-4">No drivers available for these dates.</p>';
        }
    } catch (error) {
        console.error('Error loading drivers:', error);
        listElement.innerHTML = '<p class="text-center text-sm text-red-500 py-4">Failed to load drivers.</p>';
    }
}

function initMap() {
    // Default to Manila
    const defaultLat = 14.5995;
    const defaultLng = 120.9842;

    // Pickup Map
    map = L.map('pickupMap').setView([defaultLat, defaultLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    marker = L.marker([defaultLat, defaultLng], {
        draggable: true
    }).addTo(map);

    // Update hidden inputs
    document.getElementById('pickupLat').value = defaultLat;
    document.getElementById('pickupLng').value = defaultLng;

    marker.on('dragend', function(event) {
        const position = marker.getLatLng();
        document.getElementById('pickupLat').value = position.lat;
        document.getElementById('pickupLng').value = position.lng;
        reverseGeocode(position.lat, position.lng, 'location');
    });

    // Dropoff Map
    dropoffMap = L.map('dropoffMap').setView([defaultLat, defaultLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(dropoffMap);

    dropoffMarker = L.marker([defaultLat, defaultLng], {
        draggable: true
    }).addTo(dropoffMap);

    document.getElementById('dropoffLat').value = defaultLat;
    document.getElementById('dropoffLng').value = defaultLng;

    dropoffMarker.on('dragend', function(event) {
        const position = dropoffMarker.getLatLng();
        document.getElementById('dropoffLat').value = position.lat;
        document.getElementById('dropoffLng').value = position.lng;
        reverseGeocode(position.lat, position.lng, 'dropoffLocation');
    });

    // Try to get user current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            document.getElementById('pickupLat').value = lat;
            document.getElementById('pickupLng').value = lng;

            dropoffMap.setView([lat, lng], 15);
            dropoffMarker.setLatLng([lat, lng]);
            document.getElementById('dropoffLat').value = lat;
            document.getElementById('dropoffLng').value = lng;
        });
    }
}

async function verifyLocation(inputId, targetMap, targetMarker, latId, lngId) {
    const address = document.getElementById(inputId).value;
    if (!address) {
        alert('Please enter an address first');
        return;
    }

    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="inline-block h-3 w-3 animate-spin rounded-full border-2 border-solid border-primary border-r-transparent"></span>';

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
        const data = await response.json();

        if (data && data.length > 0) {
            const result = data[0];
            const lat = parseFloat(result.lat);
            const lon = parseFloat(result.lon);

            targetMap.setView([lat, lon], 16);
            targetMarker.setLatLng([lat, lon]);
            document.getElementById(latId).value = lat;
            document.getElementById(lngId).value = lon;
        } else {
            alert('Location not found. Please try to be more specific or manually pin on the map.');
        }
    } catch (error) {
        console.error('Geocoding error:', error);
        alert('Verification service unavailable. Please pin manually.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
}

async function reverseGeocode(lat, lon, inputId) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        const data = await response.json();
        if (data && data.display_name) {
            document.getElementById(inputId).value = data.display_name;
        }
    } catch (error) {
        console.error('Reverse geocoding error:', error);
    }
}

function calculateTotal() {
    const pickupDate = new Date(document.getElementById('pickupDate').value);
    const dropoffDate = new Date(document.getElementById('dropoffDate').value);
    
    if (!pickupDate || !dropoffDate || dropoffDate <= pickupDate) {
        return;
    }
    
    const days = Math.max(1, Math.ceil((dropoffDate - pickupDate) / (1000 * 60 * 60 * 24)));
    const dailyRate = parseFloat(vehicleData.daily_rate);
    const subtotal = dailyRate * days;
    const insurance = subtotal * 0.075; // 7.5%
    const serviceFee = subtotal * 0.02; // 2%
    const total = subtotal + insurance + serviceFee;
    const downpayment = total * 0.20; // 20%
    
    document.getElementById('ratePerDay').textContent = `₱${dailyRate.toFixed(2)}`;
    document.getElementById('numDays').textContent = days;
    document.getElementById('subtotalAmount').textContent = `₱${subtotal.toFixed(2)}`;
    document.getElementById('insuranceAmount').textContent = `₱${insurance.toFixed(2)}`;
    document.getElementById('serviceFeeAmount').textContent = `₱${serviceFee.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `₱${total.toFixed(2)}`;
    document.getElementById('downpaymentAmount').textContent = `₱${downpayment.toFixed(2)}`;
}

// Create booking
document.getElementById('proceedButton').addEventListener('click', async function() {
    const pickupDate = document.getElementById('pickupDate').value;
    const dropoffDate = document.getElementById('dropoffDate').value;
    const location = document.getElementById('location').value;
    const description = document.getElementById('pickupDescription').value;
    const lat = document.getElementById('pickupLat').value;
    const lng = document.getElementById('pickupLng').value;

    const dropoffLocation = document.getElementById('dropoffLocation').value;
    const dropoffDescription = document.getElementById('dropoffDescription').value;
    const dropoffLat = document.getElementById('dropoffLat').value;
    const dropoffLng = document.getElementById('dropoffLng').value;

    const withDriver = document.getElementById('withDriver').checked;
    const driverId = document.getElementById('selectedDriverId').value;
    
    if (!pickupDate || !dropoffDate || !location || !dropoffLocation) {
        alert('Please fill in all fields including return location');
        return;
    }

    if (withDriver && !driverId) {
        alert('Please select a driver or uncheck "With Driver"');
        return;
    }
    
    const pickup = new Date(pickupDate);
    const dropoff = new Date(dropoffDate);
    
    if (dropoff <= pickup) {
        alert('Dropoff date must be after pickup date');
        return;
    }
    
    this.disabled = true;
    this.innerHTML = '<span class="inline-block h-5 w-5 animate-spin rounded-full border-4 border-solid border-white border-r-transparent"></span> Creating booking...';
    
    try {
        const response = await fetch('../api/bookings.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: user.user_id,
                vehicle_id: vehicleId,
                driver_id: withDriver ? driverId : null,
                pickup_date: pickupDate,
                dropoff_date: dropoffDate,
                pickup_location: location,
                pickup_description: description,
                pickup_latitude: lat,
                pickup_longitude: lng,
                dropoff_location: dropoffLocation,
                dropoff_description: dropoffDescription,
                dropoff_latitude: dropoffLat,
                dropoff_longitude: dropoffLng
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Store booking data for payment page
            localStorage.setItem('currentBooking', JSON.stringify(data.data));
            
            // Redirect to payment page
            window.location.href = `payment_proof_upload.html?booking_id=${data.data.booking_id}`;
        } else {
            alert(data.error || 'Failed to create booking');
            this.disabled = false;
            this.innerHTML = '<span class="material-symbols-outlined text-lg">lock</span><span>Create Booking</span><span class="material-symbols-outlined text-lg">arrow_forward</span>';
        }
    } catch (error) {
        console.error('Error creating booking:', error);
        alert('An error occurred. Please try again.');
        this.disabled = false;
        this.innerHTML = '<span class="material-symbols-outlined text-lg">lock</span><span>Create Booking</span><span class="material-symbols-outlined text-lg">arrow_forward</span>';
    }
});

// Initialize
loadVehicle();
</script>

</body></html>
